---
title: "STAT 535 Final Project - Fall 2021"
author: 'Names: Said Arslan, Declan Gray-Mullen, and Rakeen Tanvir'
date: 'Due Date: December 15, 2021, 5:59pm'
output:
  html_document:
    toc: yes
    number_sections: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(modelr)
```

# Completed Tasks:

Install GitHub and GitHub Desktop App

Share repo on GitHub to usernames: graydh, arslansaid

# Abstract:

Predictive Model of Systemic Crises in Africa

• Full names of group members

Said Arslan
Declan Gray-Mullen
Rakeen Tanvir

• A brief description of the project and data collection (website, date type etc.)

https://www.kaggle.com/chirin/africa-economic-banking-and-systemic-crisis-data


• Objectives and interests

This is an exploratory observational study of how economic conditions have evolved in African countries since they gained independence. The study will:

(a) Summarize the key trends for GDP, inflation, exchange rate, and crises. 

(b) Identify which countries have experienced the biggest economic changes. 

(c) Determine what factors are driving these patterns and what evidence could be assembled to test these hypotheses with further investigation.

  
# Investigate...

Deeper dive into variables and data sources/definitions
  Data collection
  Data manipulation
  
Difference in differences?

Interaction/effects of economic variables?

Regression - robust, logistic, interaction

At which annual rate of inflation does an Inflation Crisis become a practical certainty?

• Class material to be used for the analysis

RMarkdown
Data Types - lists, data frames, tibbles 
Flow Control - if, else, while, repeat
Strings & Regular Expression - character (country code, country)
  Web scraping - aggregate data on African countries
Data Transformations (dplyr & SQL)
Visualization (ggplot) - regression, inflation CPI vs. year, country, etc. 
Factors - country
Model fitting/optimization - regression
Functions of functions - helper functions, custom functions for regression
Sampling - empirical data vs. theoretical distribution using chi-square goodness of fit tests, bootstrapping
Monte Carlo - homework #2
  Identify distribution for data
  Investigate whether t-test is appropriate with power study
  Determine confidence interval for variable of interest
Bootstrapping - quantify uncertainty with confidence interval of point estimate (double numeric predictor variables)

• A description of the responsibilities of each of the group members.

Web Scraping - Declan
Econometrics - Said
GitHub & Rmd - Rakeen

• Conclusion (If you don’t have the conclusion yet, please just present it on the presentation day.)

Null hypothesis: All regression coefficients equal 0. That is, the predictors cannot predict crises.

Alternative hypothesis: Not all regression coefficients equal 0. That is, the predictors can predict crises.


# Data collection and preparation

## Data collection

### What type of observational study are we conducting? 

Confirmatory - confirm or not confirm hypothesis derived from previous studies or hunches

Exploratory - search for explanatory variables that might be related to the response variable

If confirmatory, which explanatory variables are:

Primary variables - involved in the hypothesis

Control variables - included to reflect existing knowledge by accounting for known influences on the response variable


Sources

https://www.kaggle.com/chirin/africa-economic-banking-and-systemic-crisis-data

Global Crises Dataset: https://www.hbs.edu/behavioral-finance-and-financial-stability/data/Pages/global.aspx

Collection methodology

The dataset is a derivative of Reinhart et al's Global Crises dataset. It was downloaded from: https://www.hbs.edu/behavioral-finance-and-financial-stability/data/Pages/global.aspx Non-African countries were filtered out from the dataset. And, variables containing notes or sparse data were removed. Years with no data were also filtered out.

Context

This dataset is a derivative of Reinhart et. al's Global Financial Stability dataset which can be found online at: https://www.hbs.edu/behavioral-finance-and-financial-stability/data/Pages/global.aspx

The dataset will be valuable to those who seek to understand the dynamics of financial stability within the African context.

Content

The dataset specifically focuses on the Banking, Debt, Financial, Inflation and Systemic Crises that occurred, from 1860 to 2014, in 13 African countries, including: Algeria, Angola, Central African Republic, Ivory Coast, Egypt, Kenya, Mauritius, Morocco, Nigeria, South Africa, Tunisia, Zambia and Zimbabwe.

Acknowledgements

Reinhart, C., Rogoff, K., Trebesch, C. and Reinhart, V. (2019) Global Crises Data by Country.
[online] https://www.hbs.edu/behavioral-finance-and-financial-stability/data. Available at: https://www.hbs.edu/behavioral-finance-and-financial-stability/data/Pages/global.aspx [Accessed: 17 July 2019].

On this page we present data collected over many years by Carmen Reinhart (with her coauthors Ken Rogoff, Christoph Trebesch, and Vincent Reinhart). These include Banking Crisis dates for more than 70 countries from 1800-present, exchange rate crises, stock market crises, sovereign debt growth and default, and many other data series. 

To see Carmen’s related research, please visit her website here:

https://carmenreinhart.com/debt-and-debt-crises/

https://carmenreinhart.com/wp-content/uploads/2020/02/229_data.pdf


The BFFS Project keeps this data updated and available for download. Please email us with any questions.

Inspiration

My inspiration stems from two questions: "Which factors are most associated with Systemic Crises in Africa?" And; "At which annual rate of inflation does an Inflation Crisis become a practical certainty?"

## Data preparation

### Import and transform into tidy data

```{r}
(ac <- 
   read_csv("reference/african_crises.csv", 
    col_types = cols(
        case = col_integer(), 
        cc3 = col_factor(ordered = TRUE), 
        country = col_character(),
        
        year = col_date(format = "%Y"),
        
        exch_usd = col_double(),
        gdp_weighted_default = col_double(), 
        inflation_annual_cpi = col_double(),
        
        systemic_crisis = col_logical(), 
        domestic_debt_in_default = col_logical(), 
        sovereign_external_debt_default = col_logical(), 
        independence = col_logical(), 
        currency_crises = col_integer(), 
        inflation_crises = col_logical(),
        
        banking_crisis = col_character()
    )
  ) 
  %>% mutate(banking_crisis = (banking_crisis == "crisis"))
  %>% mutate(currency_crises = (currency_crises > 0)) # assume 2==1 in 4 cases
)

assertthat::noNA(ac)
```
```{r, include=FALSE}
df = ac
```

The data is tidy: Each variable has its own column, each observation has its own row, and each value has its own cell.

### The variables in `ac`

1. `case` is a factor variable that identifies the index for each country from the original, global dataset.  

2. `cc3` is a factor variable that identifies each country with a three letter code.

3. `country` is a factor variable that names each country.

4. `year` is a date variable that identifies the year of the observation.

5. `systemic_crisis` <logical> that identifies whether the observation is associated with a systemic crisis. 

6. `exch_usd` <dbl>

7. `domestic_debt_in_default` <int>

8. `sovereign_external_debt_default` <int>

9. `gdp_weighted_default` <dbl>

10. `inflation_annual_cpi` <dbl>

11. `independence` <logical>

12. `currency_crises` <logical>

13. `inflation_crises` <logical>

14. `banking_crisis` <logical>

### View the factor variables with plots and a tibble

```{r}
plt <- ggplot(data = df)
plt + geom_bar(mapping = aes(x = case))
plt + geom_bar(mapping = aes(x = cc3))
plt + geom_bar(mapping = aes(x = country)) +
  theme(axis.text.x=element_blank())

(factors <- unique(df[ , 1:3]) )

```

### Focus on years following independence. 

```{r}
plt + 
  geom_point(mapping = aes(x = year, y = independence, color = country))

(indep_table <- df %>% 
  filter(independence == 1) %>%  
  group_by(country) %>% 
  summarize(indep_year = min(year), count = n() ) %>% 
  arrange(indep_year) %>% 
  mutate(prop = count/sum(count))
)




```

Most countries achieved independence by 1965. The four exceptions are Algeria (1968) and Angola (1975) on the later end and Egypt (1860) and South Africa (1910) on the earlier end. Consequently, Algeria and Angola have less filtered observations for analysis, while Egypt and South Africa alone would make up a large proportion of the data used for analysis. The four countries combined makeup almost about 40% of the data, so let's use the proportion sizes to help us decide how to split the data for training/exploration and validation (query and test).

```{r}
plt + 
  geom_point(mapping = aes(x = year, y = systemic_crisis, color = country))

(sys_crisis_table <- df %>% 
  filter(systemic_crisis == 1) %>%  
  group_by(country) %>% 
  summarize(earliest_sys_crisis = min(year), count = n() ) %>% 
  arrange(earliest_sys_crisis) %>% 
  mutate(prop = count/sum(count))
)
```

Only 82 total systemic crises in data, with the earliest occurring in Algeria in 1870 and in Egypt in 1907. Perhaps we should focus on analysis on the more recent period from 1976 and on, which also coincides with the time period when all countries had achieved independence, in order to train the model on data characterized by recent economic conditions under independence.


### Split the data into three pieces

~60% of the data goes into a training (or exploration) set

~20% goes into a test set used to compare models by hand

~20% is held back for a validation set to test the final model

What split decision rule should we follow?

1. Split by country.

2. Randomly select observations from the four highlighted countries to split among the query and test sets. 

3. Randomly select observations from the entire data set to split among the training, query, and test sets. 

Because we are working with time series data, let's maintain continuity over time and split the data by country.

```{r}
train_df <- 
```


### Optional: Scrape data off web HTML
latitude, longitude, almanac/climate


## Preliminary checks on data quality

### Edit checks and plots to identify gross data errors and extreme outliers

## Preliminary model investigation

### Simple Logistic Regression Model

```{r}
ac_matrix <- as.matrix(ac[5:ncol(ac)])
Y <- ac_matrix[ , "systemic_crisis"]
X <- cbind( rep(1, nrow(ac_matrix)), ac_matrix[ , 2:ncol(ac_matrix)] )

```


```{r}
likelihood <- function(B0, B1, X) {
  return ( ( 1 + exp( -t(X) )^(-1) ) )
}
```

```{r}
log_likelihood <- function(B0, B1, X, Y) {
  return ( sum( Y * log( likelihood(B0, B1, X) )  + ( length(Y) - sum(Y) ) * log( 1 - likelihood(B0, B1, X) ) ) )
}
```

```{r}
ll_data <- function(B0, B1) {
  return( log_likelihood(B0, B1, X = X, Y = Y) )
}
```

```{r}
ll_helper <- function(params) {
  return ( -ll_data(params[1], params[2]) )
}
```

Generate test data:

```{r}
n <- 1e4
Y <- rep( rbernoulli(n, p = .1) )
X <- Y + .1

params <- c(.5, .5)

(best <- optim(par = params, fn = ll_helper, method = "L-BFGS-B") )
```


### Diagnostics for relationships and strong interactions

### Apply remedial measures, if needed


# Reduction of number of explanatory variables (for exploratory observational studies)

Not required for confirmatory observational studies. 

## Determine several potentially useful subsets of explanatory variables; include known essential variables


# Model refinement and selection

## Investigate curvature and interaction effects more fully

## Study residuals and other diagnostics

## Apply remedial measures, if needed

## Select tentative model


# Model validation - 2-3 data sets

## Validity checks

## Final regression model